---
title: "Rproject_semesterproj"
author: "Lisa Wahlen"
date: "`r Sys.Date()`"
output: html_document
---

## Load Libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(readr) # to import tabular data (e.g. csv)
library(dplyr) # to manipulate (tabular) data
library(ggplot2) # to visualize data
library(sf) # to handle spatial vector data
library(terra) # To handle raster data
library(lubridate) # To handle dates and times
library(SimilarityMeasures)
library(RColorBrewer)
library(tmap)

mycolors4 <- brewer.pal(4, "BrBG")
```

## Read Data

```{r}
posmo <- read_csv("data/posmo_2023-05-18T00_00_00+02_00-2023-05-18T23_59_59+02_00.csv")
```

Evtl. könnte man die Daten auf die AV-Daten legen. So kann man dann alle Trajectories löschen, welche sich auf einer Strasse befinden.

```{r}
posmo <- st_as_sf(posmo, coords = c("lon_x","lat_y"), crs = 4326) |>
  st_transform(2056)

head(posmo)

posmo_coordinates <- st_coordinates(posmo)

posmo <- cbind(posmo, posmo_coordinates)

posmo_transport <- select(posmo, -c("weekday", "place_name", "user_id"))
posmo <- select(posmo, -c("weekday", "place_name", "transport_mode", "user_id"))
```

## first plots, visualization
```{r}
# overview datapoints
ggplot(posmo, aes(x=X, y=Y))+
  geom_point()+
  coord_fixed()

# overview transport mode
ggplot(posmo_transport, aes(x=X, y=Y, color=transport_mode))+
  geom_point()+
  coord_fixed()

# overview with map background
tmap_mode("view")
tm_shape(posmo_transport)+
  tm_dots("transport_mode")

```
most of the trajectory is labelled with the transport mode "car". The loop located in the south of the trajectory shows the part where Lisa went downhill-biking in Diemtigtal, Allmiried. Most of that section is labelled as "car", wherease some points are labelled as "walk". We now want to try to find out some criteria in order to be able to isolate that downhill biking part and label it as "downhill biking"

## pattern

how to isolate downhill biking pattern?

things to try
- setting speed threshold
- compare to street map
- compare to elevation model (topography)
- segmentation into segments expressing different sinuosity (Laube, computational movement analysis, 2014)

speed threshold
```{r}
# calculate distance between points d_plusx for distance
# calculate time between points
# calculate speed
# calculate average speed

posmo_transport <- posmo_transport |> 
  mutate(
    d_plus1 = sqrt((lead(X)-X)^2 + (lead(Y)-Y)^2),
    d_plus2 = sqrt((lead(X,2)-X)^2 + (lead(Y,2)-Y)^2), # new offset of 2 in function lead()
    d_minus1 = sqrt((lag(X)-X)^2 + (lag(Y)-Y)^2),
    d_minus2 = sqrt((lag(X,2)-X)^2 + (lag(Y,2)-Y)^2),
    t_plus1 = difftime(lead(datetime), datetime),
    t_plus2 = difftime(lead(datetime, 2), datetime),
    t_minus1 = difftime(lag(datetime), datetime),
    t_minus2 = difftime(lag(datetime, 2), datetime),
    s_plus1 = d_plus1/as.numeric(t_plus1), # s for speed [m/s]
    s_plus2 = d_plus2/as.numeric(t_plus2),
    s_minus1 = d_minus1/-as.numeric(t_minus1),
    s_minus2 = d_minus2/-as.numeric(t_minus2)
  )

# calculate mean speed within window of two neighboring points. not exactly a temporal window because the sampling time varies slightly

posmo_transport <- posmo_transport |>
  rowwise() |>  # so the mean per row is computed
  mutate(
    speedmean = mean(c(s_plus1, s_plus2, s_minus1, s_minus2, na.rm=TRUE))
  ) |> 
  ungroup() # otherwise each row would represent a group, we don't want that

# somehow returns incorrect mean values


# explore what we just did
ggplot(posmo_transport, aes(speedmean))+
  geom_histogram(binwidth = 1)+
  geom_vline(xintercept = mean(posmo_transport$speedmean, na.rm=TRUE)) #no vline because of nan values

range(posmo_transport$speedmean, na.rm=TRUE)

posmo_transport$speedmean[1:50] # how did i get inf values? something divided by 0 returns inf. 0/0 returns NaN
pt <- is.finite(posmo_transport$speedmean) # returns TRUE if it is not one of the values NA, NaN, Inf or -Inf
length(pt[pt == FALSE]) # counts NA, NaN, Inf and -Inf. we have 82 of those
```


Aurelia 19.06.2023

```{r}
# plot points with inf and non numeric value. let's see which points are affected.

inf_filter <- posmo_transport |> 
  filter(!is.finite(speedmean))

tmap_mode("view")
tm_shape(posmo_transport)+
  tm_dots()+
  tm_shape(inf_filter)+
  tm_dots("transport_mode")

# of 2,237 rows only 82 rows are affected (3.67 %). since the +-Inf, NaN and NA values emerge where either the distance or the time between two points is 0, the points in question seem to be static (either temporally or locally). where no speed can be computed, no evaluation regarding a threshold can be taken. 

posmo_transport <- posmo_transport |> 
  filter(is.finite(speedmean)) 

ggplot(posmo_transport, aes(speedmean))+
  geom_histogram(binwidth = 1)+
  geom_vline(xintercept = mean(posmo_transport$speedmean))

tm_shape(posmo_transport)+
  tm_dots("transport_mode")

```



